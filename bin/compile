#!/bin/sh

echo ">>>>> into compile shell"

DIR_BUILD=${1:-}
DIR_CACHE=${2:-}
DIR_ENV=${3:-}

echo DIR_BUILD=$DIR_BUILD
echo DIR_CACHE=$DIR_CACHE
echo DIR_ENV=$DIR_ENV

export RUSTUP_HOME="$DIR_CACHE/.rustup"
export CARGO_HOME="$DIR_CACHE/.cargo"

ls -al $DIR_CACHE

if [ ! -d "$CARGO_HOME" ] || [ ! -d "$CARGO_HOME/bin" ] || [ ! -f "$CARGO_HOME/bin/rustup" ]; then
    echo "installing rustup"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain nightly
fi

ls -al $DIR_CACHE

echo $PATH
export PATH="$CARGO_HOME/bin":$PATH

rustup self update
rustup update --no-self-update

cd $DIR_BUILD

BUILD_PATH="$DIR_CACHE/target"
BUILD_EXEC="$BUILD_PATH/release/slitu"

BIN_PATH="$DIR_BUILD/bin/release"
mkdir -p $BIN_PATH

cargo build --target-dir $BUILD_PATH --release
cp "$BUILD_EXEC" "$BIN_PATH/"
