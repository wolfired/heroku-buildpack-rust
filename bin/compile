#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

DIR_BUILD=${1:-}
DIR_CACHE=${2:-}
DIR_ENV=${3:-}

export RUSTUP_HOME="$DIR_CACHE/.rustup"
export CARGO_HOME="$DIR_CACHE/.cargo"

if [ ! -d "$CARGO_HOME" ] || [ ! -d "$CARGO_HOME/bin" ] || [ ! -f "$CARGO_HOME/bin/rustup" ]; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain nightly
fi

source "$CARGO_HOME/env"

rustup self update
rustup update --no-self-update

cd $DIR_BUILD

BUILD_PATH="$DIR_CACHE/target"
BUILD_EXEC="$BUILD_PATH/release/slitu"

BIN_PATH="$DIR_BUILD/bin/release"
mkdir -p $BIN_PATH

cargo build --target-dir $BUILD_PATH --release
chmod 766 $BUILD_EXEC
cp "$BUILD_EXEC" "$BIN_PATH/"
